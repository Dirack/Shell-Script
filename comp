#!/bin/bash
#
# comp (Shell Script)
#
# Objetivo: Realizar a compilação e adicionar programas ao
# pacote de processamento sísmico MADAGASCAR.
# 
# Site: http://www.dirackslouge.online
#
# Versão 2.0
#
# Programador: Rodolfo A. C. Neves 10/01/2019 (original 1.0)
#	       Rodolfo A. C. Neves 11/05/2019 (modificada 2.0)
# 
# email: rodolfo_profissional@hotmail.com
# 
# Licença: Software de uso livre e código aberto.

# Saída padrão de erro do programa
ERRO="/tmp/erro.txt"

# Verificar se o usuário forneceu algum parâmetro
[ -z "$1" ] && {
	exec 28> "$ERRO"
	echo "O usuário não forneceu nenhum parâmetro!" 
	echo "Digite $0 -h para obter ajuda!" 
	date >&28
	echo "ERRO(1): Usuário não forneceu parâmetros ao programa" >&28	
	exit 1 
}

#----------------{ Configuração de variáveis }-----------------------------#
#	Ao mudar o endereço da pasta na variável USER, o programa pode 
#	ser adaptado para a compilação de programas de outro usuário.

# Diretório principal do pacote MADAGASCAR
TOP="/home/dirack/Downloads/madagascar-2.0-1/madagascar-2.0"

# Pasta PADRÃO do usuário rodolfo dentro do pacote MADAGASCAR
USER="$TOP/user/rodolfo"
 
# Versão deste programa
VERSAO="Versão 2.0"

#--------------------------------------------------------------------------#

MENSAGEM_USO="
$(basename $0) [-h | -v | -c ]
-h --help Exibe esta mensagem de ajuda e sai
-v --version Exibe a Versão do programa e sai
-c usuario Realiza a compilação e adiciona os programas ao pacote MADAGASCAR

Exemplo de uso: 
	bash$ $0 -c rodolfo
"

case "$1" in
-h | --help) ## Exibir ajuda
	echo -e "$MENSAGEM_USO"
	exit 0
;;

-v | --version) ## Exibir versão
	echo "$VERSAO"
	exit 0
;;

-c) ## Compilar e adicionar programas ao MADAGASCAR
	
	exec 28> "$ERRO"

	## Modificação para alterar a pasta por linha de comandos
	## se não for fornecido o usuário em $2, utilize a pasta PADRÃO
	if [ -n "$2" ] 
	then
		# Pasta do usuário dentro do pacote MADAGASCAR
		USER="$TOP/user/$2"

		# Verificar se o usuário possui diretório na instalação MADAGASCAR
		if [ ! -d "$USER" ]
		then
			echo -e "Usuário \033[31m$2\033[m NÃO encontrado!"
			echo -e "Endereço consultado:\n$USER"
			exit 10
		fi
	fi

	# Mover para a pasta de usuário e rodar o scons
	if cd "$USER" 2> /dev/null
	then 
		echo -e "\033[35mCompilando conteúdo de $USER\033[m"
	else
		echo -e "\033[31mDiretório $USER não encontrado!\033[m"
		date >&28
		echo "ERRO(4) diretório $USER não encontrado!" >&28
		exit 4
	fi

	# Informar o usuário se ocorrer erro de compilação
	# direcionar a saída de erro para 'erro.txt'
	if scons 2>&28
	then

		echo -e "\033[35mCompilação realizada com sucesso!\033[m"

		# Conseguiu compilar?
		# Adicione os programas ao pacote MADAGASCAR
		cd "$TOP" # Mover para o diretório principal

		if sudo scons install 2>&28 # Instalar
		then
			echo -e "\033[35mInstalação realizada com sucesso!\033[m"
		else
			echo -e "\033[31mERRO durante a instalação!\033[m"
			date >&28
			echo "ERRO(5): erro de instalação !" >&28
			cat "$ERRO"
			exit 5
		fi	

	else
		date >&28 
		echo "ERRO(2): Erro de compilação em $USER" >&28
		echo -e "\033[31mErro de compilação em $USER!!!\033[m"
		cat "$ERRO"
		exit 2
	fi

	exit 0
;;

*) ## Usuário forneceu parâmetro desconhecido
	echo -e "\033[31mERRO: Opção $1 desconhecida!\033[m"
	echo "\033[31mDigite $0 -h para obter ajuda\033[m"
	exec 28> "$ERRO"
	date >&28
	echo "ERRO(2): Usuário forneceu \$1=$1 parâmetro desconhecido ao programa" >&28
	exit 3
;;
esac
