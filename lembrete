#!/bin/bash
# 
# Lembrete (Shell Script)
# 
# Objetivo: Armazenar lembretes e idéias no arquivo $HOME/.post
# 
# Site: http://www.dirackslounge.online
# 
# Versão 1.0
# 
# Programador: Rodolfo A. C. Neves (Dirack)	 27/12/2018
# 
# email: rodolfo_profissional@hotmail.com
# 
# Licença: Software de uso livre e código aberto.

# Biblioteca de funções para formatar a mensagem de ajuda
source mensagemAjuda.sh 

VERSAO="Versão 1.0"
SEPARADOR=":"
ARQUIVO_LEMBRETES="$HOME/.post"

# Verificar se o usuário passou algum parâmetro pela linha de comandos
[ -z "$1" ] && {
	echo "Usuário não forneceu nenhum parâmetro!"
	echo "Digite $0 -h para obter ajuda!"
	exit 1
}

# Verificar se o arquivo de banco de dados exite
# Se não, crie
[ -f "$ARQUIVO_LEMBRETES" ] || {
	touch "$ARQUIVO_LEMBRETES"
}

NOME_PROGRAMA="$(basename $0)"
DESCRICAO="Armazenar lembretes e idéias no arquivo $ARQUIVO_LEMBRETES"
PARAMETROS="-h --help::Exibe esta mensagem de ajuda e sai
-v --version::Exibe a versão do programa e sai
-a --add::Adicionar lembretes
-l --list::Listar lembretes
-r --remove::Remover lembretes"
EXEMPLO_DE_USO="~$ $0 -a tag -m \"Mensagem\" # Adicionar lembrete tag=Mensagem
	~$ $0 -l tag # Procurar por lembrete chamado 'tag'
"

case "$1" in
	-h | --help) # Exibir ajuda
		clear
		exibirMensagemAjudaProgramaFormatada "$NOME_PROGRAMA" "$DESCRICAO" "$PARAMETROS" "$EXEMPLO_DE_USO"
		exit 0
	;;

	-v | --version) # Exibir versão do programa
		echo "$VERSAO"
		exit 0	
	;;

	-a | --add) # Adicionar lembretes, a sintaxe é: ./lembrete -a tag -m "Mensagem"

		# Verificar se o usuário forneceu corretamente o comando
		[ -z "$2" -o -z "$3" -o "$3" != "-m" -o -z "$4" ] && {
			echo "ERRO: Sintaxe incorreta do comando!"
			echo 'A sintaxe correta é:'
			echo "$0 -a tag -m Mensagem"
			exit 2
		}
		
		# Verificar se lembrete já existe
		existe=$(cut -d"${SEPARADOR}" -f1 $ARQUIVO_LEMBRETES | grep -x "$2")
		[ -z "$existe" ] || {
			echo "ERRO: lembrete já cadastrado!"
			exit 2
		}
		
		# Campos do arquivo $HOME/.post
		# tag:lembrete:data:hora
		# Usa uma máscara '§' para o caractere ':'
		MSG="$4"
		MSG=$(echo "$MSG" | sed 's/:/§/g')
		echo "$2${SEPARADOR}$MSG${SEPARADOR}$(date +%d-%m-%Y)${SEPARADOR}$(date +%H-%M-%S)" >> "$ARQUIVO_LEMBRETES"
		
		echo "lembrete cadastrado com sucesso!"
		exit 0
	;;

	-l | --list) # Listar lembretes armazenados no arquivo $HOME/.post
	    
		# Se nenhuma chave específica for passada, mostre todos
		[ -z "$2" ] && {
			echo "Lembretes cadastrados: "
			cut -d"${SEPARADOR}" -f1 "$ARQUIVO_LEMBRETES"

			echo -e "\n*Digite $0 -l NomeDoLembrete para exibir um lembrete específico."
			exit 0
		}

		# Se uma chave específica for passada, procure o lembrete e a linha
		existe=$(cut -d"${SEPARADOR}" -f1 $ARQUIVO_LEMBRETES | grep -nx "$2" | cut -d":" -f1)

		# Se o lembrete NÃO foi encontrado, informe ao usuário
		if [ -z "$existe" ] 
		then 
			echo "ERRO: lembrete NÃO encontrado!"
			exit 2
		else

		# Se o lembrete foi encontrado, exiba o lembrete ao usuário
			TMP=$(sed -n "${existe}p" $ARQUIVO_LEMBRETES)
			LEMBRETE=$(echo "$TMP" | cut -d"${SEPARADOR}" -f1)
			DATA=$(echo "$TMP" | cut -d"${SEPARADOR}" -f3 | tr '-' '/')
			HORA=$(echo "$TMP" | cut -d"${SEPARADOR}" -f4 | tr '-' ':')
			MSG=$(echo "$TMP" | cut -d"${SEPARADOR}" -f2 | sed 's/§/:/g')
			echo "LEMBRETE= $LEMBRETE"
			echo "DATA= $DATA"
			echo "HORA= $HORA"
			echo "MENSAGEM= $MSG"
			exit 0
		fi

		
	;;

	-r | --remove) # remover lembrete armazenado no arquivo $HOME/.post

		# Verificar se o usuário forneceu corretamente o comando
		[ -z "$2" ] && {
			echo "ERRO: Sintaxe incorreta do comando!"
			echo 'A sintaxe correta é:'
			echo "$0 -r lembrete"
			exit 2
		}

		# Verificar se lembrete já existe
		existe=$(cut -d"$SEPARADOR" -f1 $ARQUIVO_LEMBRETES | grep -nx "$2" | cut -d":" -f1)

		if [ -z "$existe" ] 
		then
			echo "ERRO: lembrete NÃO encontrado!"
			exit 2
		else
			sed -i "${existe}d" $ARQUIVO_LEMBRETES		
			echo "lembrete $2 apagado!"
			exit 0
		fi

		
	;;

	*)
		echo "ERRO: Opção $1 desconhecida!"
		echo "Digite $0 para obter ajuda"
		exit 1
	;;
esac
